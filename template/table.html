<!DOCTYPE html>
<html>
    <head>
        <title>BoCloud</title>
        <link rel="stylesheet" type="text/css" href="base.css">
    </head>
    <body>
        <table id='table-test'>
            <tr>
                <th>device</th>
                <th>data</th>
            </tr>
            <jsondata>
        </table>
    </body>
        <script>

            // sse
            var source = new EventSource('/stream')
            source.addEventListener('message', function(msg) {
                var json_data = JSON.parse(msg.data)
                console.log(json_data);
                for (let i = 0; i < json_data.length; i++) {
                    var newTableTR = document.createElement('tr');

                    var keys = Object.keys(json_data[i]);
                    for (let j = 0; j < keys.length; j++) {
                        var newTableTD = document.createElement('td');
                        var TDTextNode = document.createTextNode(json_data[i][keys[j]]);
                        newTableTD.appendChild(TDTextNode);
                        newTableTR.appendChild(newTableTD);
                    }

                    tableElement.appendChild(newTableTR);
                }
            })

            // drag table
            var tableElement = document.getElementById('table-test')
            tableElement.style.left = localStorage.getItem("tposX");
            tableElement.style.top = localStorage.getItem("tposY");

            tableElement.addEventListener('mousedown', function(event) {
                event.preventDefault();
                let initX = event.clientX;
                let initY = event.clientY;
                function moveElement(event) {
                    let currentX = event.clientX;
                    let currentY = event.clientY;
                    let deltaX = currentX - initX;
                    let deltaY = currentY - initY;
                    tableElement.style.left = tableElement.offsetLeft + deltaX + 'px';
                    tableElement.style.top = tableElement.offsetTop + deltaY + 'px';
                    initX = currentX;
                    initY = currentY;
                }

                function stopElement(event) {
                    localStorage.setItem('tposX', tableElement.style.left);
                    localStorage.setItem('tposY', tableElement.style.top);
                    document.removeEventListener('mousemove', moveElement);
                    document.removeEventListener('mouseup', stopElement);
                }

                document.addEventListener('mousemove', moveElement);
                document.addEventListener('mouseup', stopElement);

            })
        </script>
</html>
